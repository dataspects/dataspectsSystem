require 'dataspects'
require 'awesome_print'

module Dataspects

  class Indexer

    def initialize(dataspects_api_url:, dataspects_api_key:, es_url:, tika_url:)
      @dataspects_api_url = dataspects_api_url
      @dataspects_api_key = dataspects_api_key
      @esc = ElasticsearchCluster.new(url: es_url)
      @tika_url = tika_url
    end

    def execute
      raise NotImplementedError.new
    end

  end

  class CookbookFALnetIndexer < Indexer

    def initialize(dataspects_api_url:, dataspects_api_key:, es_url:, tika_url:)
      super
      index = 'dataspectspublic'
      if(@esc.client.indices.exists?(index: index))
        @esc.client.indices.delete(index: index)
      end
      @esc.client.indices.create(index: index)
      @esc.client.indices.close(index: index)
      @esc.client.indices.put_settings(
        index: index,
        body: JSON.parse(File.read(
          'elasticsearch/standard_index_settings.json'))
      )
      @esc.client.indices.put_mapping(
        index: index,
        type: 'doc',
        body: JSON.parse(File.read(
          'elasticsearch/standard_index_mapping.json'))
      )
      @esc.client.indices.open(index: index)
    end

    def execute()
      response = RestClient.get(
        @dataspects_api_url,
        headers = {
          "dataspects-api-key": @dataspects_api_key,
          content_type: :json,
          accept: :json
        }
      )
      resources = JSON.parse(response)
      resources.each do |resource|
        esdoc = {
          # Resource silo level
          OriginatedFromResourceSiloID: "",
          OriginatedFromResourceSiloLabel: "",
          OriginatedFromResourceSiloType: "",
          # Resource level
          OriginatedFromResourceName: resource['pagename'],
          OriginatedFromResourceURL: "",
          OriginatedFromResourceType: "",
          # Entity/subject level
          HasEntityClass: resource['hasEntityClass'],
          HasEntityName: resource['hasEntityName'],
          HasEntityType: resource['hasEntityType'],
          HasEntityURL: resource['hasEntityURL'],
          HasEntityTitle: resource['hasEntityTitle'],
          HasEntityBlurbTEXT: resource['hasEntityBlurbTEXT'],
          HasEntityBlurbHTML: resource['hasEntityBlurbHTML'],
          HasEntityContentTEXT: "",
          HasEntityContentHTML: resource['nonFormssemanticizedWikitextHtml'],
          HasEntityTypeAndEntityTitle: "#{resource['hasEntityType']} \"resource['hasEntityTitle']\"",
          HasEntityKeywords: resource['hasEntityKeywords'],
          HasEntityAnnotations: resource['annotations']
        }
        @esc.index(
          body: esdoc,
          index: "dataspectspublic"
        )
      end
    end

  end
end

# Run by "ruby index_cookbook_entities.rb"
$development_tika_url = "http://localhost:9998"
mwsi = Dataspects::CookbookFALnetIndexer.new(
  dataspects_api_url: "http://localhost:3000/api/mediawikis/5c8bab5ee03192424251b7c9/pages",
  dataspects_api_key: "aslkdjasldkjlaskdj",
  tika_url: $development_tika_url,
  es_url: "http://localhost:9200"
).execute
