---

- hosts: localhost
  gather_facts: False
  tasks:

    - name: CHECK if "{{ dataspectsSystem_control_folder_on_host }}/dataspects-file-feeder" exists
      stat:
        path: "{{ dataspectsSystem_control_folder_on_host }}/dataspects-file-feeder"
      register: dataspects_file_feeder_exists
      tags:
        - 610_feed_dataspectsSystem_source_folder

    - fail:
        msg: "{{ dataspectsSystem_control_folder_on_host }}/dataspects-file-feeder not found, download from https://github.com/dataspects/dataspects-file-feeder/releases"
      when: dataspects_file_feeder_exists.stat.exists == False
      tags:
        - 610_feed_dataspectsSystem_source_folder

    - name: COPY dataspects-file-feeder-config.json
      template:
        src: ../../ansible_templates/dataspects-file-feeder-config.json.j2
        dest: "{{ dataspectsSystem_control_folder_on_host }}/dataspects-file-feeder-config.json"
      tags:
        - 610_feed_dataspectsSystem_source_folder

    - name: RUN dataspects-file-feeder
      shell: ./dataspects-file-feeder --config dataspects-file-feeder-config.json --feeder-id dsicf --database dsicf.db
      args:
        chdir: "{{ dataspectsSystem_control_folder_on_host }}"
      when: dataspects_file_feeder_exists.stat.exists == True
      tags:
        - 610_feed_dataspectsSystem_source_folder
