---

- hosts: localhost
  gather_facts: False
  tasks:

    ############################################################################
    - name: Register {{ dataspectsSystem_control_folder_on_host | basename | lower }}_mediawiki_root path on host
      shell: docker volume inspect {{ dataspectsSystem_control_folder_on_host | basename | lower }}_mediawiki_root
      register: volume_profile
      when: docker_volumes_mode == 'automatic'
      tags:
        - 320_install_mediawiki_extensions
    - set_fact: mountpoint={{ dict(volume_profile.stdout | from_json | json_query('[].[Name,Mountpoint]')).items()[0][1] }}
      when: docker_volumes_mode == 'automatic'
      tags:
        - 320_install_mediawiki_extensions
    - set_fact: mountpoint={{ manual_docker_volumes_location }}mediawiki_root
      when: docker_volumes_mode == 'manual'
      tags:
        - 320_install_mediawiki_extensions
    ############################################################################

    - name: Place MediaWiki extensions list
      template:
        src: ../../ansible_templates/mediawiki_extensions.yml.j2
        dest: "{{ mountpoint }}/w/mediawiki_extensions.yml"
        mode: 0777
      become: "{{ 'true' if platform == 'linux' else 'false' }}"
      tags:
        - 320_install_mediawiki_extensions

    - name: Place MediaWiki extensions install script
      template:
        src: ../../ansible_templates/install_mediawiki_extensions.rb.j2
        dest: "{{ mountpoint }}/w/install_mediawiki_extensions.rb"
        mode: 0777
      become: "{{ 'true' if platform == 'linux' else 'false' }}"
      tags:
        - 320_install_mediawiki_extensions

    - name: Install MediaWiki extensions
      shell: ruby install_mediawiki_extensions.rb
      args:
        chdir: "{{ mountpoint }}/w/"
      become: "{{ 'true' if platform == 'linux' else 'false' }}"
      tags:
        - 320_install_mediawiki_extensions

    # [[IsOperationType::FileSystemOperation]]
    - name: Set permissions on mediawiki root
      file:
        path: "{{ mountpoint }}/w/"
        owner: www-data
        recurse: yes
      become: "{{ 'true' if platform == 'linux' else 'false' }}"
      when:
        platform == 'linux'
      tags:
        - 320_install_mediawiki_extensions
